```{r echo=FALSE }
options(scipen=999)#eliminates scientific notation
```

# SEM: Model Respecifications {#respecify}

[Screencasted Lecture Link](https://youtube.com/playlist?list=PLtz5cFLQl4KM2212ST28Rw4-KPMhdfDmX&si=E_-QuJzTxPcDHtIr) 

In the prior two lessons we engaged in the first of two steps structural equation modeling. We first established the *measurement model.* Next we specified and evaluated a *structural model*, which included testing alternative models. In this lesson we consider how to use model statistics to consider respecifying the model through *building* and *trimming*. Further, we learn how to compare these models to determine if the fit is improved (i.e., a goal when we free parameters to be in relation with each other), stayed the same (i.e., a goal when we trim paths, thereby fixing their relation to 0.00), or deteriorated.

## Navigating this Lesson

There is about # hour and ## minutes of lecture.  If you work through the materials with me it would be plan for an additional ###.

While the majority of R objects and data you will need are created within the R script that sources the chapter, occasionally there are some that cannot be created from within the R framework. Additionally, sometimes links fail.  All original materials are provided at the [Github site](https://https://github.com/lhbikos/ReC_MultivModel) that hosts the book. More detailed guidelines for ways to access all these materials are provided in the OER's [introduction](#ReCintro)

### Learning Objectives

Learning objectives from this lecture include the following:

* Explain the terms associated with model building (e.g. releasing/freeing constraints, forward search, adding paths) and model trimming (e.g., imposing constraints, deleting free parameters, backward search, deleting paths).
* Define and interpret *modification indices*.
* Use modification indices to determine whether or not to "add a path."
* Describe how to use regression weights and significance in the determination of trimming a path.
* Compare the fit to determine if there are statistically significant differences between the baseline and modified models.
* Memorize which model (nested or nesting) will have better fit (without looking at the results).

### Planning for Practice

In this lesson we focus on model modifications. In-so-doing, we use statistical criteria to determine whether or not to build or trim the model, we compare the fit of the models statistically, and we interpret whether or not we prefer the baseline or modified model. The homework assignment will require you to begin with an established structural model (for which the measurement model is strong), use statistical criterion to choose to add or delete at least one path or covariance, compare the fit of the two models, and determine which to retain. As always, the suggestions for practice are graded in complexity. You might:

* Rework the problem in the chapter by changing the random seed in the code that simulates the data.  This should provide minor changes to the data, but the results will likely be very similar.
* Use the research data from the chapter, but evaluate a different set of variables.
* Use data from another lesson or data that is available to you.

### Readings & Resources

In preparing this chapter, I drew heavily from the following resource(s). Other resources are cited (when possible, linked) in the text with complete citations in the reference list.

* Kline, R. (2016). Principles and practice of structural equation modeling (Fourth ed., Methodology in the social sciences). New York: The Guilford Press.
  - Chapter 10, Specification and Identification of Structural Regression Models
  - Chapter 14, Analysis of Structural Regression Models
* Byrne, B. M. (2016). Structural equation modeling with AMOS: Basic concepts, applications, and programming (3rd ed.). Routledge. http://ebookcentral.proquest.com/lib/spu/detail.action?docID=4556523
  - Chapter 1, Structural Equation Modeling: The basics
  - Chapter 6, Application 4:  Testing the Factorial Validity of a Causal Structure
* Lewis, J. A., Williams, M. G., Peppers, E. J., & Gadson, C. A. (2017). Applying intersectionality to explore the relations between gendered racism and health among Black women. *Journal of Counseling Psychology, 64*(5), 475–486. https://doi-org.ezproxy.spu.edu/10.1037/cou0000231
  - This is the research vignette for this lesson.

### Packages

The script below will (a) check to see if the following packages are installed on your computer and, if not (b) install them.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70), warning=FALSE, message = FALSE}
#will install the package if not already installed
#if(!require(lavaan)){install.packages("lavaan")}
#if(!require(semPlot)){install.packages("semPlot")}
#if(!require(tidyverse)){install.packages("tidyverse")}
#if(!require(psych)){install.packages("psych")}
#if(!require(jtools)){install.packages("jtools")}
```

## Respecifying Structural Models

There is general consensus ([@byrne_structural_2016-2; @chou_model_2002]) that of the three types of approaches to model building (i.e., strictly confirmatory, alternative models, model generating [@bollen_testing_1993]), that model generating is the most commonly used. This means that researchers will respecify the model by either adding paths or covariances, trimming paths or covariances, or both. At the risk of oversimplification, modelers generally take a model building or model trimming approaches. But of course -- there is complexity and nuance that we should unravel.

### Model Building

In model building, the researcher starts with a more parsimonious model and proceeds to a more general model. Chou and Bentler [-@chou_model_2002] termed this *forward searching.* In general, this requires specifying a model that is *overidentified* (i.e., it has positive degrees of freedom). If the model does not fit the data well, we will request *modification indices*. These values are presented in the metric of the chi-square test and will tell us "by how much the chi-square value will decrease" if the two elements listed in each (of a long list) of the results is freed to relate (i.e., by a path or covariance). In a one-degree chi-square test, statistically significant change occurs when the modification index is greater than 3.841. 

*Freeing parameters* is an activity that should be done with caution. Freeing a single parameter by adding a directional path or bidirectional covariance will reduce the degrees of freedom in the structural model by 1. Correspondingly, this respecified model will be the *nesting* model and will (in all likelihood) have better fit. The chi-square value will decrease by the amount indicated in the modification index and, presuming the parameter was freed because it would result in a statistically significant decrease in the unit of the chi-square, the respecified model with the additional path(s) may look as if it is a superior model. When fit is increasing incrementally, it can be tempting to keep freeing parameters until degrees of freedom are zero and the model is *just identified*. Doing so, risks *overparameterization*. This means that the model is *overfit*. Although it appears to fit the sample data well, it may fail to generalize to a different set of data that represents the population of interest. That is, the model is sample-specific which makes it less useful in making predictions or generalizing more broadly.

Thus, there are are cautions about model the forward searching approach:

* Any paths that are added (i.e., any parameters that are freed) should have strong theoretical justification.
* Any paths that are added should be statistically sensible. The procedure we use to produce modification indices, will produce them for every unsaturated paths. Sensible relations would generally include
  - directional paths between variables in the structural model, and
  - error covariances in the measurement model (for more on this see the lesson, [CFA: Hierarchical and Nested Models](https://lhbikos.github.io/ReC_Psychometrics/CFA2nd.html#navigating-this-lesson-9)
* Avoid adding paths that are not sensible. An example would be a path between an indicator in the measurement model and a structural variable.
  - but do think about why the modification index might be suggesting such; perhaps it is a clue to an error.

### Model Trimming

In model trimming, the researcher starts with a more general model or saturated (i.e., zero degrees of freedom in the structural model) and, on the basis of statistical criteria, trims non-significant (i.e., and low regression weight) paths from the model. Chou and Bentler [-@chou_model_2002] termed this *backward searching.* The general process is to identify and delete non-essential paths one at a time and evaluate the "hit to the fit." Given that the more saturated model is the *nesting model*, one can expect that trimmed, *nested* model will have fit that is incrementally lower. The hope is that the difference does not bring the global fit indices into thresholds that indicate poor fit and that, when compared statistically, the nested model is not statistically significantly different than the nesting model.

Several prominent researchers appear to favor the model trimming/backward searching approach. Chou and Bentler [-@chou_model_2002] acknowledged that while the forward searching approach is commonly utilized its ability to find the *true* model has been questioned. Their Monte Carlo based test study demonstrated that a backward search approach that imposed constraints with the *z* and Wald(*W*) tests identified the *true* model with greater than 60% accuracy. Kenny's [@kenny_sem_2012] SEM website and workshops have also advocated for a model trimming approach that generally starts with a *just-identified* (i.e., saturated, df = 0) model and trims paths, one-at-a-time, to see if the adequately fitting result resembled the theoretical model they identified, apriorily. 

### Restating Approaches to Respecification

The terms, concepts, and logic related to nesting, saturation, and respecification can be confusing. Hopefully, this table can help clarify their meaning and role.

|Approach to Respecification |Hypothesized (Original model) is|Comparison model(s) is |Typical Hope of $\Delta\chi^2$ test|
|:---------------------------|:---------------- |:------------------------|:---------------------|
|Model building, forward search |overidentified, df > 0 |more paths, fewer df |significant indicating additional path improved model fit|  
|Model trimming, backward search |just-identified, df = 0 |fewer paths, more df |non-significant indicating deleted path did not lead to poorer model fit|  

In today's lesson, we will start with a rather complex, over-identified model. Following the example Byrne's [@byrne_application_2016-3] chapter, we will first use modification indices to see about freeing parameters (i.e., adding paths) and then inspect nonsignificant paths for possible constraint (e.g., deletion).

## Workflow for Evaluating a Structural Model

Below is the overall workflow for evaluating a structural model. Today our focus is the specification and evaluation of the structural model.

![A colorful image of a workflow for evaluating structural models](images/IntroSEM/StructuralModelWorkflow.png) 
Evaluating a structural model involves the following steps:

* A Priori Power Analysis
  - Conduct an a priori power analysis to determine the appropriate sample size.
  _ Draw estimates of effect from pilot data and/or the literature.
* Scrubbing & Scoring
  - Import data and format (i.e., variable naming, reverse-scoring) item level variables.
  - Analyze item-level missingness.
  - If using scales, create the mean scores of the scales.
  - Determine and execute approach for managing missingness. Popular choices are available item analysis (e.g., Parent, 2013) and multiple imputation.
  - Analyze scale-level missingness.
  - Create a df with only the items (scaled in the proper direction).
* Data Diagnostics
  - Evaluate univariate normality (i.e., one variable at a time) with Shapiro-Wilks tests; p < .05 indicates a violation of univariate normality.
  - Evaluate multivariate normality (i.e., all continuously scaled variables simultaneously) with Mahalanobis test. Identify outliers (e.g., cases with Mahal values > 3 SDs from the centroid). Consider deleting (or transforming if there is an extreme-ish “jump” in the sorted values.
  - Evaluate internal consistency of the scaled scores with Cronbach’s alpha or omega; the latter is increasingly preferred.
Specify and evaluate a measurement model
  - In this just-identified (saturated) model, all latent variables are specified as covarying.
    + For LVs with 3 items or more, remember to set a marker/reference variable,
    + For LVs with 2 items, constrain the loadings to be equal,
    + For single-item indicators fix the error variance to zero (or a non-zero estimate of unreliability).
  - Evaluate results with global (e.g., X2, CFI, RMSEA, SRMR) and local (i.e., factor loadings and covariances) fit indices.
  - In the event of poor fit, respecify LVs with multiple indicators with parcels.
  - Nested alternative measurement models can be compared with Χ2 difference, ΔCFI tests; non-nested models with AIC, and BIC tests .
* Specify and evaluate a structural model.
  - Replace the covariances with paths that represent the a priori hypotheses.
    + These models could take a variety of forms.
    + It is possible to respecify models through trimming or building approaches.
  - Evaluate results using
    + *global* fit indices (e.g., X2, CFI, RMSEA, SRMS),
    + *local* fit indices (i.e., strength and significance of factor loadings, covariances, and additional model parameters [e.g., indirect effects]).
  - Consider respecifying and evaluating one or more *alternative* models.
    + *Forward searching* involves freeing parameters (adding paths or covariances) and can use modification indices as a guide.
    + *Backward searching* involves restraining parameters (deleting paths or covariances) and can use low and non-significant paths as a guide.
  - Compare the fit of the alternate models.
    + Nested models can be compared with Χ2 difference and ΔCFI tests.
    + Non-nested models can be compared with AIC and BIC (lower values suggest better fit).
* Quick Guide for Global and Comparative Fit Statistics.
  - $\chi^2$, p < .05; this test is sensitive to sample size and this value can be difficult to attain
  - CFI > .95 (or at least .90)
  - RMSEA (and associated 90%CI) are < .05 ( < .08, or at least < .10)
  - SRMR < .08 (or at least <.10)
  - Combination rule:  CFI < .95 and SRMR < .08
  - AIC and BIC are compared; the lowest values suggest better models
  - $\chi^2\Delta$ is statistically significant; the model with the superior fit is the better model
  - $\delta CFI$ is greater than 0.01; the model with CFI values closest to 1.0 has better fit

## Research Vignette

Once again the research vignette comes from the Lewis, Williams, Peppers, and Gadson's [-@lewis_applying_2017] study titled, "Applying Intersectionality to Explore the Relations Between Gendered Racism and Health Among Black Women."  The study was published in the Journal of Counseling Psychology. Participants were 231 Black women who completed an online survey. 

Variables used in the study included:

* **GRMS**:  Gendered Racial Microaggressions Scale [@lewis_construction_2015] is a 26-item scale that assesses the frequency of nonverbal, verbal, and behavioral negative racial and gender slights experienced by Black women. Scaling is along six points ranging from 0 (never) to 5 (once a week or more).  Higher scores indicate a greater frequency of gendered racial microaggressions. An example item is, "Someone has made a sexually inappropriate comment about my butt, hips, or thighs."

* **MntlHlth** and **PhysHlth**: Short Form Health Survey - Version 2 [@ware_comparison_1995] is a 12-item scale used to report self-reported mental (six items) and physical health (six items).
Higher scores indicate higher mental health (e.g., little or no psychological ldistress) and physical health (e.g., little or no reported symptoms in physical functioning). An example of an item assessing mental health was, "How much of the time during the last 4 weeks have you felt calm and peaceful?"; an example of a physical health item was, "During the past 4 weeks, how much did pain interfere with your normal work?"

* **Sprtlty**, **SocSup**, **Engmgt**, and **DisEngmt** are four subscales from the Brief Coping with Problems Experienced Inventory [@carver_you_1997]. The 28 items on this scale are presented on a 4-point scale ranging from 1 (*I usually do not do this at all*) to 4(*I usually do this a lot*).  Higher scores indicate a respondents' tendency to engage in a particular strategy.  Instructions were modified to ask how the female participants responded to recent experiences of racism and sexism as Black women. The four subscales included spirituality (religion, acceptance, planning), interconnectedness/social support (vent emotions, emotional support,instrumental social support), problem-oriented/engagement coping (active coping, humor, positive reinterpretation/positive reframing), and disengagement coping (behavioral disengagement, substance abuse, denial, self-blame, self-distraction).

* **GRIcntlty**:  The Multidimensional Inventory of Black Identity Centrality subscale [@sellers_multidimensional_nodate] was modified to measure the intersection of racial and gender identity centrality.  The scale included 10 items scaled from 1 (*strongly disagree*) to 7 (*strongly agree*). An example item was, "Being a *Black woman* is important to my self-image."  Higher scores indicated higher levels of gendered racial identity centrality.

Today we will use the simulated data to evaluate a model that was suggested by a figure in the journal (one IV, four mediators, two dependent variables) but was not tested as a single structural model. Rather, the authors ran a series of four simple mediations per dependent variable for a total of eight separate analyses. The authors do not elaborate on their rationale for this appraoch. My guess is that they were limited in design by their use of ordinary least squares with the PROCESS macro in SPSS. Additionally, they may have been concerned about power when they considered a more complicated, latent variable, design.

Specifically, we will specify a parallel mediation model where two dependent variables (i.e., mental health, physical health) are predicted directly from gendered racial microaggressions and indirectly through four coping strategies (i.e., spirituality, social support, engagement, disengagement).

![An image of the hypothesized (original) model being evaluated in this lesson.](images/IntroSEM/Lewis_multmed_theoretical.png) 

### Simulating the data from the journal article

The *lavaan::simulateData* function was used. If you have taken psychometrics, you may recognize the code as one that creates latent variables form item-level data. In trying to be as authentic as possible, we retrieved factor loadings from psychometrically oriented articles that evaluated the measures [@nadal_racial_2011; @veit_structure_1983]. For all others we specified a factor loading of 0.80. We then approximated the *measurement model* by specifying the correlations between the latent variable. We sourced these from the correlation matrix from the research vignette  [@lewis_applying_2017]. The process created data with multiple decimals and values that exceeded the boundaries of the variables. For example, in all scales there were negative values. Therefore, the final element of the simulation was a linear transformation that rescaled the variables back to the range described in the journal article and rounding the values to integer (i.e., with no decimal places).

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70), warning=FALSE, message=FALSE}
#Entering the intercorrelations, means, and standard deviations from the journal article


Lewis_generating_model <- '
        #measurement model
        GRMS  =~ .69*Ob1 + .69*Ob2 + .60*Ob3 + .59*Ob4 + .55*Ob5 + .55*Ob6 + .54*Ob7 + .50*Ob8 + .41*Ob9 + .41*Ob10 + .93*Ma1 + .81*Ma2 + .69*Ma3 + .67*Ma4 + .61*Ma5 + .58*Ma6 + .54*Ma7 + .59*St1 + .55*St2 + .54*St3 + .54*St4 + .51*St5 + .70*An1 + .69*An2 + .68*An3
        MntlHlth  =~ .8*MH1 + .8*MH2 + .8*MH3 + .8*MH4 + .8*MH5 + .8*MH6
        PhysHlth  =~ .8*PhH1 + .8*PhH2 + .8*PhH3 + .8*PhH4 + .8*PhH5 + .8*PhH6
        Spirituality  =~ .8*Spirit1 + .8*Spirit2
        SocSupport  =~ .8*SocS1 + .8*SocS2
        Engagement  =~ .8*Eng1 + .8*Eng2
        Disengagement  =~  .8*dEng1 + .8*dEng2
        GRIC  =~ .8*Cntrlty1 + .8*Cntrlty2 + .8*Cntrlty3 + .8*Cntrlty4 + .8*Cntrlty5 + .8*Cntrlty6 + .8*Cntrlty7 + .8*Cntrlty8 + .8*Cntrlty9 + .8*Cntrlty10
   
        #Means
         GRMS ~ 1.99*1
         Spirituality ~2.82*1
         SocSupport ~ 2.48*1
         Engagement ~ 2.32*1
         Disengagement ~ 1.75*1
         GRIC ~ 5.71*1
         MntlHlth ~3.56*1 #Lewis et al used sums instead of means, I recast as means to facilitate simulation
         PhysHlth ~ 3.51*1 #Lewis et al used sums instead of means, I recast as means to facilitate simulation
         
        #Correlations 
         GRMS ~ 0.20*Spirituality
         GRMS ~ 0.28*SocSupport
         GRMS ~ 0.30*Engagement
         GRMS ~ 0.41*Disengagement
         GRMS ~ 0.19*GRIC
         GRMS ~ -0.32*MntlHlth
         GRMS ~ -0.18*PhysHlth
         
         Spirituality ~ 0.49*SocSupport
         Spirituality ~ 0.57*Engagement
         Spirituality ~ 0.22*Disengagement
         Spirituality ~ 0.12*GRIC
         Spirituality ~ -0.06*MntlHlth
         Spirituality ~ -0.13*PhysHlth
         
         SocSupport ~ 0.46*Engagement
         SocSupport ~ 0.26*Disengagement
         SocSupport ~ 0.38*GRIC
         SocSupport ~ -0.18*MntlHlth
         SocSupport ~ -0.08*PhysHlth
         
         Engagement ~ 0.37*Disengagement
         Engagement ~ 0.08*GRIC
         Engagement ~ -0.14*MntlHlth
         Engagement ~ -0.06*PhysHlth
         
         Disengagement ~ 0.05*GRIC
         Disengagement ~ -0.54*MntlHlth
         Disengagement ~ -0.28*PhysHlth
         
         GRIC ~ -0.10*MntlHlth
         GRIC ~ 0.14*PhysHlth
     
         MntlHlth ~ 0.47*PhysHlth         
        '

set.seed(230925)
dfLewis <- lavaan::simulateData(model = Lewis_generating_model,
                              model.type = "sem",
                              meanstructure = T,
                              sample.nobs=231,
                              standardized=FALSE)

#used to retrieve column indices used in the rescaling script below
#col_index <- as.data.frame(colnames(dfLewis))

for(i in 1:ncol(dfLewis)){  # for loop to go through each column of the dataframe 
  if(i >= 1 & i <= 25){   # apply only to GRMS variables
    dfLewis[,i] <- scales::rescale(dfLewis[,i], c(0, 5))
  }
  if(i >= 26 & i <= 37){   # apply only to mental and physical health variables 
    dfLewis[,i] <- scales::rescale(dfLewis[,i], c(0, 6))
  }
  if(i >= 38 & i <= 45){   # apply only to coping variables
    dfLewis[,i] <- scales::rescale(dfLewis[,i], c(1, 4))
  }
  if(i >= 46 & i <= 55){   # apply only to GRIC variables
    dfLewis[,i] <- scales::rescale(dfLewis[,i], c(1, 7))
  }
}

#rounding to integers so that the data resembles that which was collected
library(tidyverse)
dfLewis <- dfLewis %>% round(0) 

#quick check of my work
#psych::describe(dfLewis) 

```
The script below allows you to store the simulated data as a file on your computer. This is optional -- the entire lesson can be worked with the simulated data.

If you prefer the .rds format, use this script (remove the hashtags). The .rds format has the advantage of preserving any formatting of variables. A disadvantage is that you cannot open these files outside of the R environment.

Script to save the data to your computer as an .rds file.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#saveRDS(dfLewis, 'dfLewis.rds')  
```

Once saved, you could clean your environment and bring the data back in from its .csv format.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#dfLewis<- readRDS('dfLewis.rds')
```

If you prefer the .csv format (think "Excel lite") use this script (remove the hashtags). An advantage of the .csv format is that you can open the data outside of the R environment. A disadvantage is that it may not retain any formatting of variables

Script to save the data to your computer as a .csv file.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#write.table(dfLewis, file = 'dfLewis.csv', sep = ',', col.names=TRUE, row.names=FALSE) 
```

Once saved, you could clean your environment and bring the data back in from its .csv format.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#dfLewis<- read.csv ('dfLewis.csv', header = TRUE)
```

## Scrubbing, Scoring, and Data Diagnostics

Because the focus of this lesson is on the specific topic of specifying and evaluating a structural model for SEM and have used simulated data, we are skipping many of the steps in scrubbing, scoring and data diagnostics. If this were real, raw, data, it would be important to [scrub](https://lhbikos.github.io/ReC_MultivModel/scrub.html), if needed [score](https://lhbikos.github.io/ReC_MultivModel/score.html), and conduct [data diagnostics](https://lhbikos.github.io/ReC_MultivModel/DataDx.html) to evaluate the suitability of the data for the proposes analyses.

## Script for Specifying Models in *lavaan*

SEM in *lavaan* requires fluency with the R script. Below is a brief overview of the operators we use most frequently:

* Latent variables (factors) must be *defined* by their manifest or latent indicators.  
  + the special operator (=~, *is measured/defined by*) is used for this
  + Example:  f1 =~ y1 + y2 + y3
* Regression equations use the single tilda (~, *is regressed on*)
  + place DV (y) on left of operator
  + place IVs, separate by + on the right
  + Example:  y ~ f1 + f2 + x1 + x2
    - *f* is a latent variable in this example
    - *y*, *x1*, and *x2* are observed variables in this example
  + An asterisk can affix a label in subsequent calculations and in interpreting output
* Variances and covariances are specified with a double tilde operator (~~, *is correlated with*)
  + Example of variance:  y1 ~~ y1 (the relationship with itself)
  + Example of covariance:  y1 ~~ y2 (relationship with another variable)
  + Example of covariance of a factor:  f1 ~~ f2
*Intercepts (~ 1) for observed and LVs are simple, intercept-only regression formulas
  + Example of variable intercept:  y1 ~ 1
  + Example of factor intercept:  f1 ~ 1

A complete lavaan model is a combination of these formula types, enclosed between single quotation models. Readibility of model syntax is improved by:

* splitting formulas over multiple lines
* using blank lines within single quote
* labeling with the hashtag

## Quick Specification of the Measurement Model

Recall that the first step in establishing a structural model is to specify, evaluate, and if necessary re-specify the measurement model. For this data I have specified the measurement model as follows:

* Gendered Racial Microaggressions Scale (GRMS): randomly assign the 26 items to 3 parcels.
* Mental health (MH): randomly assign the 6 items to 3 parcels.
* Physical health (PhH): randomly assign the 6 items to 3 parcels.
* Coping strategies (spiritual/Spr, social support (SSp), engagement (Eng), disengagement (dEng): Constrain the loadings for each of the two variables per construct to be equal.

For more information on establishing measurement models please visit the lesson on [establishing the measurement model](https://lhbikos.github.io/ReC_MultivModel/MeasMod.html). Here is a representation of the measurement model we are specifying.

![An image of the measurement model that we are specifying ](images/IntroSEM/Lewis_msmt_mod.png) 
To proceed with this approach, I first need to create parcels for the GRMS, MH, and PhH scales. This code randomly assigns the GRMS items to three parcels.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
set.seed(230916)
items <- c('Ob1', 'Ob2', 'Ob3', 'Ob4', 'Ob5', 'Ob6', 'Ob7', 'Ob8', 'Ob9', 'Ob10', 'Ma1', 'Ma2', 'Ma3', 'Ma4', 'Ma5', 'Ma6', 'Ma7', 'St1', 'St2', 'St3', 'St4', 'St5', 'An1', 'An2')
parcels <- c("GRMS_p1", "GRMS_p_2","GRMS_p3")
data.frame(items = sample(items),
           parcel = rep(parcels, length = length(items)))  
```

We can now create the parcels using the same scoring procedure as we did for the REMS and CMI instruments.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
GRMS_p1_vars <- c('Ma3','Ma7', 'Ma1', 'Ob1', 'St2', 'Ob8', 'An2', 'Ma4')
GRMS_p2_vars <- c('Ob7','Ma5', 'An1', 'St3', 'Ob5', 'Ma6', 'Ma2', 'St1')
GRMS_p3_vars <- c('Ob9','Ob2', 'Ob4', 'Ob6', 'Ob10', 'St5', 'Ob3', 'St4')

dfLewis$p1GRMS <- sjstats::mean_n(dfLewis[, GRMS_p1_vars], .75)
dfLewis$p2GRMS <- sjstats::mean_n(dfLewis[, GRMS_p2_vars], .75)
dfLewis$p3GRMS <- sjstats::mean_n(dfLewis[, GRMS_p3_vars], .75)

#If the scoring code above does not work for you, try the format below which involves inserting to periods in front of the variable list. One example is provided.
#dfLewis$p3PWB <- sjstats::mean_n(dfLewis[, ..PWB_p3_vars], .75)
```

This code randomly assigns the mental health items to three parcels.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
set.seed(230916)
items <- c('MH1', 'MH2', 'MH3', 'MH4', 'MH5', 'MH6')
parcels <- c("MH_p1", "MH_p2","MH_p3")
data.frame(items = sample(items),
           parcel = rep(parcels, length = length(items)))  
```

This code provides means for each of the three REMS parcels.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
MH_p1_vars <- c('MH5','MH6')
MH_p2_vars <- c('MH1','MH3')
MH_p3_vars <- c('MH4','MH2')

dfLewis$p1MH <- sjstats::mean_n(dfLewis[, MH_p1_vars], .75)
dfLewis$p2MH <- sjstats::mean_n(dfLewis[, MH_p2_vars], .75)
dfLewis$p3MH <- sjstats::mean_n(dfLewis[, MH_p3_vars], .75)

#If the scoring code above does not work for you, try the format below which involves inserting to periods in front of the variable list. One example is provided.
#dfLewis$p3REMS <- sjstats::mean_n(dfLewis[, ..REMS_p3_vars], .80)
```

This code randomly assigns the physical health items to three parcels.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
set.seed(230916)
items <- c('PhH1', 'PhH2', 'PhH3', 'PhH4', 'PhH5', 'PhH6')
parcels <- c("PhH_p1", "PhH_p2","PhH_p3")
data.frame(items = sample(items),
           parcel = rep(parcels, length = length(items)))  
```

This code provides means for each of the three REMS parcels.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
PhH_p1_vars <- c('PhH5','PhH6')
PhH_p2_vars <- c('PhH1','PhH3')
PhH_p3_vars <- c('PhH4','PhH2')

dfLewis$p1PhH <- sjstats::mean_n(dfLewis[, PhH_p1_vars], .75)
dfLewis$p2PhH <- sjstats::mean_n(dfLewis[, PhH_p2_vars], .75)
dfLewis$p3PhH <- sjstats::mean_n(dfLewis[, PhH_p3_vars], .75)

#If the scoring code above does not work for you, try the format below which involves inserting to periods in front of the variable list. One example is provided.
#dfLewis$p3REMS <- sjstats::mean_n(dfLewis[, ..REMS_p3_vars], .80)
```


Below is code for specifying the measurement model. Each of the latent variables/factors (REMS, CMI, PWB) is identified by three parcels. Each of the latent variables is allowed to covary with the others.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
msmt_mod <- "
        ##measurement model
         GRMS =~ p1GRMS + p2GRMS + p3GRMS
         MH =~ p1MH + p2MH + p3MH  
         PhH =~ p1PhH + p2PhH + p3PhH 
         Spr =~ v1*Spirit1 + v1*Spirit2
         SSp =~ v2*SocS1 + v2*SocS2
         Eng =~ v3*Eng1 + v3*Eng2
         dEng =~ v4*dEng1 + v4*dEng2
         
      
        # Covariances
         GRMS ~~ MH
         GRMS ~~ PhH
         GRMS ~~ Spr
         GRMS ~~ SSp
         GRMS ~~ Eng
         GRMS ~~ dEng
         MH ~~ PhH
         MH ~~ Spr
         MH ~~ SSp
         MH ~~ Eng
         MH ~~ dEng
         PhH ~~ Spr
         PhH ~~ SSp
         PhH ~~ Eng
         PhH ~~ dEng
         Spr  ~~ SSp
         Spr  ~~ Eng
         Spr  ~~ dEng
         SSp ~~ Eng
         SSp ~~ dEng
         Eng ~~ dEng
         
        "

set.seed(230916)
msmt_fit <- lavaan::cfa(msmt_mod, data = dfLewis, missing = "fiml")
msmt_fit_sum <- lavaan::summary(msmt_fit, fit.measures = TRUE, standardized = TRUE)
msmt_fit_pEsts <- lavaan::parameterEstimates(msmt_fit, boot.ci.type = "bca.simple", standardized=TRUE)
msmt_fit_sum
#msmt_fit_pEsts #although creating the object is useful to export as a .csv I didn't ask it to print into the book
```

The factor loadings were all strong, statistically significant, and properly valenced. Further, global fit statistics were within acceptable thresholds ($\chi^2(102) = 94.122, p = 0.698, CFI = 1.000, RMSEA = 0.000, 90CI[0.000,	 0.028], SRMR =  0.034$).

The figure below is an illustration of our measurement model with its results. It also conveys that each latent variable is indicated by three parcels and all of the latent variables are allowed to covary.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
semPlot::semPaths(msmt_fit, what = "col", whatLabels = "stand", sizeMan = 5, node.width = 1, edge.label.cex = .75, style = "lisrel", mar = c(5,5,5,5))

#semPlot::semPaths(msmt_fit) #ignore -- used to create a no-results figure earlier in the chapter
```
Below is script that will export the global fit indices (via *tidySEM::table_fit*) and the parameter estimates (e.g., factor loadings, structural regression weights, and parameters we requested such as the indirect effect) to .csv files that you can manipulate outside of R.  
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#global fit indices
msmt_fitstats <- tidySEM::table_fit(msmt_fit)
write.csv(msmt_fitstats, file = "msmt_fitstats.csv")
#the code below writes the parameter estimates into a .csv file
write.csv(msmt_fit_pEsts, file = "msmt_pEsts.csv")
```


Here's how I might write an APA style summary of establishing the measurement model.

>Analyzing our proposed multiple mediator model followed the two-step procedure of first evaluating a measurement model with acceptable fit to the data and then proceeding to test the structural model. Given that different researchers recommend somewhat differing thresholds to determine the adequacy of fit, We used the following as evidence of good fit: comparative fit indix (CFI) $\geq 0.95$, root-mean-square error of approximation (RMSEA) $\leq 0.06$, and the standard root-mean-square residual (SRMR) $\leq 0.08$. To establish aceptable fit, we used CFI $\geq 0.90$, RMSEA $\leq 0.10$, and SRMR $\leq 0.10$ [@weston_brief_2006].

>To evaluate the measurement model we followed recommendations by Little et al. [@little_parcel_2002; @little_why_2013]. Specifically, each latent variable with six or more indicators was represented by three parcels. Parcels were created by randomly assigning scale items to the parcels and then calculating the mean, if at least 65% of the items were non-missing. For the four latent variables with only two indicators each, we constrained the factor loadings to be equal. Factor loadings were all strong, statistically significant, and properly valenced. Global fit statistics were within acceptable thresholds ($\chi^2(102) = 94.122, p = 0.698, CFI = 1.000, RMSEA = 0.000, 90CI[0.000,	 0.028], SRMR =  0.034$). Thus, we proceeded to testing the structural model.

Table 1  

|Factor Loadings for the Measurement Model              
|:-------------------------------------------------------------|

|                         
|:----------------------------:|:-----:|:----:|:-----:|:------:|
| Latent variable and indicator|est    |SE    | *p*   |est_std |

|
|:-----------------------------|:-----:|:----:|:-----:|:------:|
|**Gendered Racial Microaggressions**| |      |       |        |
|Parcel 1                      |1.000	 |0.000	|       |0.956   |
|Parcel 2                      |1.014	 |0.030	|<0.001	|0.961   |
|Parcel 3                      |1.904	 |0.030	|<0.001	|0.934   |
|**Mental Health**             |       |      |       |        |
|Parcel 1                      |1.000	 |0.000	|     	|0.765   |
|Parcel 2                      |1.237	 |0.128	|<0.001	|0.728   |
|Parcel 3                      |1.241	 |0.112	|<0.001	|0.776   |
|**Physical Health**           |       |      |       |        |
|Parcel 1                      |1.000	 |0.000	|     	|0.662   |
|Parcel 2                      |0.997	 |0.125	|<0.001	|0.714   |
|Parcel 3                      |1.060	 |0.139	|<0.001	|0.727   |
|**Spiritual Coping**          |       |      |       | 
|Item 1                        |1.000	 |0.000	|     	|0.730   |
|Item 2                        |1.000	 |0.000	|       |0.762   |
|**Social Support Coping**     |       |      |       | 
|Item 1                        |1.000	 |0.000	|     	|0.704   |
|Item 2                        |1.000	 |0.000	|       |0.654   |
|**Engagement Coping**         |       |      |       |        |
|Item 1                        |1.000	 |0.000	|     	|0.612   |
|Item 2                        |1.000	 |0.000	|       |0.701   |
|**Disengagement Coping**      |       |      |       |        |
|Item 1                        |1.000	 |0.000	|     	|0.684   |
|Item 2                        |1.000	 |0.000	|       |0.652   |

Having established that our measurement model is adequate, we are ready to replace the covariances between latent variables with the paths (directional) and covariances (bidirectional) we hypothesize. These paths and covariances are *soft* hypotheses. That is, we are "freeing" them to relate. In SEM, *hard* hypotheses are where no path/covariance exists and the relationship between these variables is "fixed" to zero. This is directly related to degrees of freedom and the identification status (just-identified, over-identified, underidentified) of the model. 

## Specifying and Evaluating the Hypothesized Structural Model

As described more completely in the [lesson on specifying and evaluating the structural model](https://lhbikos.github.io/ReC_MultivModel/StructMod.html#the-structural-model-specification-and-evaluation), the **structural model** evaluates the hypothesized relations between the latent variables. The structural model is typically more parsimonious (i.e., not saturated) than the measurement model and is characterized by directional paths (not covariances) between some  (not all) of the variables.  

Here's a quick reminder of the hypothesized model we are testing. Using data simulated from the Lewis et al. [-@lewis_applying_2017]article, we are evaluating a parallel mediation model, predicting mental and physical health directly from gendered racial microaggressions and indirectly through four approaches to coping (i.e., spiritual, social support, engagement, disengagement). This model is *hybrid* because it include measurement models (i.e., latent variables indicated by their parcels), plus the hypothesized paths.

![An image of the hypothesized (original) model being evaluated in this lesson; the structural model is outlined in red.](images/IntroSEM/Lewis_multmed_sructural.png) 

### Model Identification for the Hypothesized (Original) Model

In order to be evaluated, structural models need to be *just identifed* ($df_M = 0$) or *overidentified* ($df_M > 0$). Computer programs are not (yet) good at estimating identification status because it is based on symbolism and not numbers.  Therefore, we researchers must do the mental math to ensure that our *knowns* (measured/observed variables) are equal (just-identified) or greater than (overidentified) our *unknowns* (parameters that will be estimated). Model identification is described more completely in the [lesson on specifying and evaluating the structural model](https://lhbikos.github.io/ReC_MultivModel/StructMod.html#the-structural-model-specification-and-evaluation),

**Knowns**: $\frac{k(k+1)}{2}$ where *k* is the number of *constructs* (humoR:  konstructs?)in the model.  In our case, we have seven constructs. Deploying the formula below, we learn that we have 21 knowns. 

```{r}
(7*(7+1))/2
```

**Unknowns**: are calculated with the following

  - Exogenous (predictor) variables (1 variance estimated for each):  we have 1 (GRMS) 
  - Endogenous (predicted) variables (1 disturbance variance for each):  we have 6 (Spr, SSp, Eng, dEng, MH, PhH)
  - Correlations between variables (1 covariance for each pairing): we have 0
  - Regression paths (arrows linking exogenous variables to endogenous variables): we have 14  
    
With 28 knowns and 20 unknowns, we have 8 degrees of freedom in the structural portion of the model. This is an *over-identified* model.

#### Specifying and Evaluating the Structural Model

Specifying our structural model in *lavaan* includes script for the measurement model, the structural model, and any additional model parameters (e.g., indirect and total effects) that we might add. In the script below you will see each of these elements. 

* the mediating variables (Spr, SSp, Eng, dEng) are predicted by the independent variable (GRMS),
* the dependent variables (MH, PhH) are predicted by the independent variable (GRMS) and the mediating variables (Spr, SSp, Eng, dEng),
* labels are assigned to represent the $a$, $b$, and $c'$ paths
* calculations that use the labels will estimate the indirect, direct, and total paths

In the model specification below, there are more elements to note. I have chosen to specify the dependent variables with all of the variables that predict them in a single line of code. In the script below I wrote:

```{r eval = FALSE}
MH ~ c_p1*GRMS + b1*Spr + b2*SSp + b3*Eng + b4*dEng 
```

It is equally acceptable to list them specify them from fewer predictors at a time. For example, I could have written 
```{r eval = FALSE}
MH ~ c_p1*GRMS 
MH ~ b1*Spr
MH ~ b2*SSp
MH ~ b3*Eng
MH ~ b4*dEng
```

Because *lavaan* has elements of randomness in its algorithms (particularly around its version of bias-corrected, bootstrapped confidence intervals), including a *set.seed* function will facilitate the reproducibility of results. 

If the data contain missing values, the default behavior in *lavaan::sem* is listwise deletion.  If we can presume that the missing mechanism is MCAR or MAR (e.g., there is no systematic missingness), we can specify a *full information maximum likelihood* (FIML) estimation procedure with the *missing = "fiml"* argument. Recall that we retained cases if they had 20% or less missing. Using the "fiml" option is part of the AIA approach [@parent_handling_2013].  

In the *lavaan::summary* function, we will want to retrieve the global fit indices with the *fit.measures=TRUE.* Because SEM figures are often represented with standardized values, we will want *standardized = TRUE*. And if we wish to know the proportion of variance predicted in our endogenous variables, we will include *rsq = TRUE*.

In the *lavaan::parameterEstimates* we can obtain *lavaan*'s version of bias-corrected bootstrapped confidence intervals (they aren't quite the same) by including *boot.ci.type = "bca.simple"*.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
struct_mod1 <- "
        ##measurement model
         GRMS =~ p1GRMS + p2GRMS + p3GRMS
         MH =~ p1MH + p2MH + p3MH  
         PhH =~ p1PhH + p2PhH + p3PhH 
         Spr =~ v1*Spirit1 + v1*Spirit2
         SSp =~ v2*SocS1 + v2*SocS2
         Eng =~ v3*Eng1 + v3*Eng2
         dEng =~ v4*dEng1 + v4*dEng2
         
         
        #structural model with labels for calculation of the indirect effect
         
         Eng ~ a1*GRMS
         Spr ~ a2*GRMS
         SSp ~ a3*GRMS
         dEng ~ a4*GRMS
         
         MH ~ c_p1*GRMS + b1*Eng + b2*Spr + b3*SSp + b4*dEng
         PhH ~ c_p2*GRMS  + b5*Eng + + b6*Spr + b7*SSp + b8*dEng
         
         #cov
         MH ~~ 0*PhH #prevents MH and PhD from correlating
         
          
        #calculations
         indirect.EngMH :=  a1*b1
         indirect.SprMH :=  a2*b2
         indirect.SSpMH :=  a3*b3
         indirect.dEngMH :=  a4*b4
         
         indirect.EngPhH :=  a1*b5
         indirect.SprPhH :=  a2*b6
         indirect.SSpPhH :=  a3*b7
         indirect.dEngPhH :=  a4*b8
         direct.MH  := c_p1
         direct.PhH  := c_p2
         total.MH  := c_p1 + (a1*b1) + (a2*b2) + (a3*b3) + (a4*b4)
         total.PhH  := c_p2 + (a1*b5) + (a1*b6) + (a1*b7) + (a1*b8)
          "
set.seed(230916) #needed for reproducibility especially when specifying bootstrapped confidence intervals
struct_fit1 <- lavaan::sem(struct_mod1, data = dfLewis, missing= 'fiml')
struct_summary1 <- lavaan::summary(struct_fit1, fit.measures=TRUE, standardized=TRUE, rsq = TRUE)
struct_pEsts1 <- lavaan::parameterEstimates(struct_fit1, boot.ci.type = "bca.simple", standardized=TRUE)
struct_summary1
#struct_pEsts #although creating the object is useful to export as a .csv I didn't ask it to print into the book

```

Below is script that will export the global fit indices (via *tidySEM::table_fit*) and the parameter estimates (e.g., factor loadings, structural regression weights, and parameters we requested such as the indirect effect) to .csv files that you can manipulate outside of R.  
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#global fit indices
struct_fitstats <- tidySEM::table_fit(struct_fit1)
write.csv(struct_fitstats, file = "struct_fitstats.csv")
#the code below writes the parameter estimates into a .csv file
write.csv(struct_pEsts1, file = "struct_pEsts1.csv")
```

#### Interpreting the Output

Plotting the results can be useful in checking our work and, if correct, understanding the relations between the variables.  The *semPlot::semPaths* function will produce an initial guess at what we might like that can be further tweaked.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot_struct1 <- semPlot::semPaths(struct_fit1, what = "col", whatLabels = "stand", sizeMan = 3, node.width = 1, edge.label.cex = .75, style = "lisrel", mar = c(2,2,2,2), structural = FALSE, curve=FALSE, intercepts=FALSE)
```
Although the code below may look daunting, I find it to be a fairly straightforward way to obtain figures that convey the model we are testing. We first start by identifying the desired location of our latent variables, using numbers to represent their position by "(column, row)". In the table below, I have mapped my variables. 

|Grid for Plotting semplot::sempath      
|:-------------|:-------------|:------------|
|(1,1)         |(1,2) Eng     |(1,3)        | 
|(2,1)         |(2,2) Spr     |(2,3)        |
|(3,1)         |(3,2)         |(3,3) MH     |
|(4,1)  GRM    |(4,2)         |(4,3)        |
|(5,1)         |(5,2)         |(5,3) PhH    |
|(6,1)         |(6,2) Ssp     |(6,3)        |
|(7,1)         |(7,2) dEng    |(7,3)        |

We place these values along with the names of our latent variables in to the *semptools::layout_matrix* function.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#IMPORTANT:  Must use the node names (take directly from the SemPlot) assigned by SemPlot
#You can change them as the last thing
m1_msmt <- semptools::layout_matrix(GRM = c(4,1),
                                  Eng = c(1,2),
                                  Spr = c(2,2),
                                  SSp = c(6,2),
                                  dEn = c(7,2),
                                  MH = c(3,3),
                                  PhH = c(5,3))
```

Next we provide instruction on the direction (up, down, left, right) we want the indicator/observed variables to face. We identify the direction by the location of each of our latent variables. For example, in the code below we want the indicators for the REM variable (2,1) to face left.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#tell where you want the indicators to face
m1_point_to <- semptools::layout_matrix (left = c(4,1),
                                      up = c(1,2),
                                      down = c(2,2),
                                       up = c(6,2),
                                       down = c(7,2),
                                      right = c(3,3),
                                      right = c(5,3))

```

The next two sets of code work together to specify the order of the observed variables for each factor. in the top set of code the variable names indicate the order in which they will appear (i.e., p1R, p2R, p3R). In the second set of code, the listing the variable name three times (i.e., REM, REM, REM) serves as a placeholder for each of the indicators.

It is critical to note that we need to use the abbreviated variable names assigned by *semTools::semPaths* and not necessarily the names that are in the dataframe.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#the next two codes -- indicator_order and indicator_factor are paired together, they specify the order of observed variables for each factor
m1_indicator_order <- c("p1G", "p2G", "p3G",
                     "p1M", "p2M", "p3M",
                     "p1P", "p2P", "p3P",
                     "Sp1", "Sp2",
                     "SS1", "SS2",
                     "En1", "En2",
                     "dE1", "dE2")

m1_indicator_factor <- c("GRM", "GRM", "GRM",
                      "MH", "MH", "MH",
                      "PhH", "PhH", "PhH",
                      "Spr", "Spr",
                      "SSp", "SSp",
                      "Eng", "Eng",
                      "dEn", "dEn")
```


The next two sets of codes provide some guidance about how far away the indicator (square/rectangular) variables should be away from the latent (oval/circular) variables. Subsequently, the next set of values indicate how far away each of the indicator (square/rectangular) variables should be spread apart.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#next set of code pushes the indicator variables away from the factor
m1_indicator_push <- c(GRM = .5, 
                    MH = 1,
                    PhH = 1, 
                    Spr = 2,
                    SSp = 1.5,
                    Eng = 1.5,
                    dEn = 2)

#spreading the boxes away from each other
m1_indicator_spread <- c(GRM = .5, 
                    MH = 2.5,
                    PhH = 2.5, 
                    Spr = 1,
                    SSp = 1,
                    Eng = 1,
                    dEn = 1)

```

Finally, we can feed all of the objects that whole these instructions into the *semptools::sem_set_layout* function. If desired, we can use the *semptools::change_node_label* function to rename the latent variables. Again, make sure to use the variable names that *semPlot::semPaths* has assigned.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot1 <- semptools::set_sem_layout(plot_struct1,
                                indicator_order = m1_indicator_order,
                                indicator_factor = m1_indicator_factor,
                                factor_layout = m1_msmt,
                                factor_point_to = m1_point_to,
                                indicator_push = m1_indicator_push,
                                indicator_spread = m1_indicator_spread)

#changing node labels
plot1 <- semptools::change_node_label(plot1,
                                   c(GRM = "GRMS",
                                     MH = "mHealth",
                                     PhH = "phHealth",
                                     Eng = "Engmt",
                                     dEn = "dEngmt",
                                     Spr = "Spirit",
                                     SSp = "SocSup"),
                                   label.cex = 1.1)

#adding stars to indicate significant paths
plot1 <- semptools::mark_sig(plot1, struct_fit1)

plot(plot1)
```


It can be useful to have a representation of the model without the results. This set of code produces those results. It does so by including only the name of the fitted object into the *semPlot::semPaths* function. Then it uses all the objects we just created as instructions for the figure's appearance.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#Code to plot the theoretical model (in case you don't want to print the results on the graph):
plot1_theoretical <- semPlot::semPaths(struct_fit1, sizeMan = 3, node.width = 1, edge.label.cex = .75, style = "lisrel", mar = c(2,2,2,2), structural = FALSE, curve=FALSE, intercepts=FALSE)
plot1_theoretical <- semptools::set_sem_layout(plot1_theoretical,
                                indicator_order = m1_indicator_order,
                                indicator_factor = m1_indicator_factor,
                                factor_layout = m1_msmt,
                                factor_point_to = m1_point_to,
                                indicator_push = m1_indicator_push,
                                indicator_spread = m1_indicator_spread)
plot(plot1_theoretical)
```
The statistical string for the global fit indices can be represented this way: $\chi^2(109) = 120.324, p = 0.216, CFI = 0.994, RMSEA = 0.021, 90CI[0.000, 0.041], SRMR =  0.044$.

Tabling the regression weights will assist us in understanding the relations between the variables. To be consistent with my figure, in this table I have included the standardized results (i.e., $\beta$).

**Table 2 ** 

|Model Coefficients Assessing the Effect of Gendered Racial Microaggressions on Mental and Physical Health through Coping Strategies
|:------------------------------------------------------------------------------------------|

| Predictor                            |$B$     |$SE_{B}$|$p$      |$\beta$ |$R^2$          |       
|:-------------------------------------|:------:|:------:|:-------:|:-------|:-------------:|
|**Engagement** (M1)                   |        |        |         |        |.49            |  
|Gendered Racial Microaggressions ($a_1$)|0.392	|0.041	 |< 0.001  |0.701   |               |
|**Spirituality** (M2)                 |        |        |         |        |.68            |  
|Gendered Racial Microaggressions ($a_2$)|0.554	|0.040	 |< 0.001  |0.824   |               |
|**Social Support** (M3)               |        |        |         |        |.48            |  
|Gendered Racial Microaggressions ($a_3$)|0.406	|0.042	 |< 0.001  |0.694   |               |
|**Disengagement** (M4)                |        |        |         |        |.50            |  
|Gendered Racial Microaggressions ($a_4$)|0.386	|0.041	 |< 0.001  |0.707   |               |
|**Mental Health** (DV1)               |        |        |         |        |.58            |  
|Engagement ($b_1$)                    |0.355	  |0.223	 |0.111	   |0.229   |               |
|Spirituality ($b_1$)                  |0.155	  |0.219	 |0.481	   |0.120   |               |
|Social Support ($b_3$)                |-0.012	|0.187	 |0.950	   |-0.008  |               |
|Disengagement ($b_4$)                 |-0.850	|0.303	 |0.005	   |-0.536  |               |
|Gendered Racial Microaggressions ($c'_1$)|-0.445|0.205	 |0.029	   |-0.514  |               |
|**Physical Health** (DV2)             |        |        |         |        |.30            | 
|Engagement ($b_5$)                    |0.330	  |0.250	 |0.186	   |0.222   |               |
|Spirituality ($b_6$)                  |0.215	  |0.254	 |0.398	   |0.174   |               |
|Social Support ($b_7$)                |0.016	  |0.215	 |0.939	   |0.012   |               |
|Disengagement ($b_8$)                 |-0.624	|0.295	 |0.034	   |-0.409  |               |
|Gendered Racial Microaggressions ($c'_2$)|-0.369|0.224	 |0.099	   |-0.444  |               |

|Effects                               |$B$     |$SE_{B}$|$p$      |$\beta$ |95% CI 
|:-------------------------------------|:------:|:------:|:-------:|:------:|:-------------:|
|Indirect 3($a_1*b_1$)                 |0.139	  |0.089	 |0.118	   |0.161	  |-0.035, 0.314  |
|Indirect 1($a_2*b_2$)                 |0.086	  |0.122	 |0.482	   |0.099	  |-0.153, 0.325  |
|Indirect 2($a_3*b_3$)                 |-0.005	|0.076	 |0.950	   |-0.005	|-0.154, 0.144  |
|Indirect 4($a_4*b_4$)                 |-0.328	|0.123	 |0.007	   |-0.379	|-0.569, -0.088 |
|Direct 1 ($c'_1$)                     |-0.445	|0.205	 |0.029	   |-0.514	|-0.846, -0.045 |
|Total 1 ($c_1$)                       |-0.554	|0.062	 |< 0.001  |-0.639	|-0.675, -0.432 |
|Indirect 7($a_1*b_5$)                 |0.130	  |0.099	 |0.192	   |0.156	  |-0.065, 0.324  |
|Indirect 5($a_2*b_6$)                 |0.119	  |0.141	 |0.400	   |0.143	  |-0.158, 0.396  |
|Indirect 6($a_3*b_7$)                 |0.007	  |0.087	 |0.939	   |0.008	  |-0.165, 0.178  |
|Indirect 8($a_4*b_8$)                 |-0.241	|0.117	 |0.039	   |-0.289	|-0.470, -0.012 |
|Direct 2 ($c'_2$)                     |-0.369	|0.224	 |0.099	   |-0.444	|-0.808, 0.069  |
|Total 2 ($c_2$)                       |-0.394	|0.083	 |0.000	   |-0.445	|-0.556, -0.232 |

|
|-------------------------------------------------------------------------------------------|
|*Note*. The significance of the indirect effects was calculated with bootstrapped, bias-corrected, confidence intervals (.95).|

As we can see, our model accounts for 48-68% of the variance in the mediators and 58% and 30% of the variance in the mental and physical health variables, respectively. Only one indirect effect, gendered racial microagressions to mental health, via disengagement coping. Inspection of the specific paths may provide some insight into this. Specifically, all of the *a* paths are statistically significant (i.e., gendered racial microaggressions predicting each of the four coping approaches) but only two of the *b* paths (i.e., disengagement coping to mental and physical health, respectively).

Here's how I might write up this section of the analysis:

>Our structural model was a parallel mediation, predicting mental and physical health directly from gendered racial microaggressions and indirectly through four coping strategies (i.e., spirituality, social support, engagement, disengagement). Results of the global fit indices suggested adequate fit $\chi^2(109) = 120.324, p = 0.216, CFI = 0.994, RMSEA = 0.021, 90CI[0.000, 0.041], SRMR =  0.044$. As shown in Table 2 only two of the eight indirect effects was statistically significant. For both, disengagement coping mediated the effect of gendered racial microaggressions on mental health $(B = -0.328, p = 0.007)$ and physical health $(B = -0.241, p = 0.039)$. The model accunted for 48-68% of the variance in the mediators and 58% and 30% of the variance in mental and physical health, respectively.

With such strong overall fit, if I were the researcher, I would be inclined to stop here. Given that this is a lecture on model building and trimming, let's proceed to see if respecification is indicated.

## Model Building

Recall that in model building we start with a more parsimonious model and consider "adding paths." This requires that our original model be *overidentified* with positive degrees of freedom. Earlier we determined that we had 8 degrees of freedom.

*Modification indices* are a tool that can help us determine where diretional paths or bidirectional covariances might improve model fit. A modification index is produced for each element of the model that is constrained to be zero (i.e., does not have a path or covariance). These modification indices are presented in the metric of the chi-square test and will tell us "by how much the chi-square value will decrease" if the two elements are freed to relate (i.e., by a path or covariance). In a one-degree chi-square test, statistically significant change occurs when the modification index is greater than 3.841. Thus, when researchers use the *lavaan::modindices()* function, they typically set a minimum value of 4.0 (rounding up from 3.841).

When inspecting the results, we will look for the parameters with the highest values (that are clearly above 4.0) that would be theoretically defensible. Be aware that this procedure may "suggest" many nonsensible relations.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
lavaan::modindices(struct_fit1, sort=TRUE, minimum.value=4)
```
Because we used the command, "sort=TRUE" the modification indices (in the "mi" column) are presented from highest to lowest. Having familiarity with *lavaan* syntax can be useful in deciphering what is being suggested.

The first modification index (12.40) relates to the factor loadings in the measurement model. We know this because of the "=~" operator. It suggests that we free *p2MH* (the second parcel for mental health) to *PhH* (the physical health latent variable). I would consider this "nonsensible." While this might improve model fit, this suggestion relates to our measurement model -- and our measurement model had terrific fit with no need for further improvement.

The second modification index (8.859) is accompanied by the "~~" operator. This means it is suggesting that we free the second parcel for mental health to covary (correlate) with item 2 for disengagement coping. This is not a sensible suggestion. In fact the *only* sensible suggested covariation is to free the dependent variables (PhH and MH) to covary (correlate). 

The single tilda (*~*) provides suggestions for regression paths. Note that the third and fifth recommendations are to either predict spiritual coping from social support coping or the vice versa. Further, the fourth recommendation is to allow those two variables to covary. Either of these three options would reduce our chi-square by 8.339. Keep in mind that the *lavaan::modindices* package will produce all possible combinations of ways to improve model fit, even if they are redundant.

I am intrigued by this suggested relation between spiritual coping and social support. If we added this path, we could test for the significance of an serially mediated effect from gendered racial microaggressions, to spiritual support, through social support, to mental and physical health, respectively.

![An image illustrating the most sensible path suggested by the modification indices](images/IntroSEM/ModBuild.png) 

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
struct_mod2 <- "
       ##measurement model
         GRMS =~ p1GRMS + p2GRMS + p3GRMS
         MH =~ p1MH + p2MH + p3MH  
         PhH =~ p1PhH + p2PhH + p3PhH 
         Spr =~ v1*Spirit1 + v1*Spirit2
         SSp =~ v2*SocS1 + v2*SocS2
         Eng =~ v3*Eng1 + v3*Eng2
         dEng =~ v4*dEng1 + v4*dEng2
         
         
        #structural model with labels for calculation of the indirect effect
         
         Eng ~ a1*GRMS
         Spr ~ a2*GRMS
         SSp ~ a3*GRMS
         dEng ~ a4*GRMS
         
         MH ~ c_p1*GRMS + b1*Eng + b2*Spr + b3*SSp + b4*dEng
         PhH ~ c_p2*GRMS  + b5*Eng + + b6*Spr + b7*SSp + b8*dEng
         
         SSp ~ d1*Spr
         
         #cov
         MH ~~ 0*PhH
         
          
        #calculations
         indirect.EngMH :=  a1*b1
         indirect.SprMH :=  a2*b2
         indirect.SSpMH :=  a3*b3
         indirect.dEngMH :=  a4*b4
         
         indirect.EngPhH :=  a1*b5
         indirect.SprPhH :=  a2*b6
         indirect.SSpPhH :=  a3*b7
         indirect.dEngPhH :=  a4*b8
        
         serial.MH := a2*d1*b3
         serial.PH := a2*d1*b7
          
         direct.MH  := c_p1
         direct.PhH  := c_p2
         total.MH  := c_p1 + (a1*b1) + (a2*b2) + (a3*b3) + (a4*b4) + (a2*d1*b3)
         total.PhH  := c_p2 + (a1*b5) + (a1*b6) + (a1*b7) + (a1*b8) + (a2*d1*b7)

          "
set.seed(230916) #needed for reproducibility especially when specifying bootstrapped confidence intervals
struct_fit2 <- lavaan::sem(struct_mod2, data = dfLewis, missing= 'fiml')
struct_summary2 <- lavaan::summary(struct_fit2, fit.measures=TRUE, standardized=TRUE, rsq = TRUE)
struct_pEsts2 <- lavaan::parameterEstimates(struct_fit2, boot.ci.type = "bca.simple", standardized=TRUE)
struct_summary2
#struct_pEsts2 #although creating the object is useful to export as a .csv I didn't ask it to print into the book

```

Creating a figure will help us with the conceptual understanding of what we've just done (and will also help us check our work).

Let's first create a fresh plot from se

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot_struct2 <- semPlot::semPaths(struct_fit2, what = "col", whatLabels = "stand", sizeMan = 3, node.width = 1, edge.label.cex = .75, style = "lisrel", mar = c(2,2,2,2), structural = FALSE, curve=FALSE, intercepts=FALSE)
```
Because we haven't added or deleted variables (only 1 path) and we want them to stay in the same location with the same orientation of paths and covariances, we should be able to recycle some of the diagram code we created earlier

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot2 <- semptools::set_sem_layout(plot_struct2,
                                indicator_order = m1_indicator_order,
                                indicator_factor = m1_indicator_factor,
                                factor_layout = m1_msmt,
                                factor_point_to = m1_point_to,
                                indicator_push = m1_indicator_push,
                                indicator_spread = m1_indicator_spread)

#changing node labels
plot2 <- semptools::change_node_label(plot2,
                                   c(GRM = "GRMS",
                                     MH = "mHealth",
                                     PhH = "phHealth",
                                     Eng = "Engmt",
                                     dEn = "dEngmt",
                                     Spr = "Spirit",
                                     SSp = "SocSup"),
                                   label.cex = 1.1)

#adding stars to indicate significant paths
plot2 <- semptools::mark_sig(plot2, struct_fit2)

plot(plot2)
```

As predicted by the modification indices (and our knowledge that a model with fewer degrees of freedom will generally have improved fit), the global fit indices have improved: $\chi^2(108) = 111.657, p = 0.385, CFI = 0.998, RMSEA = 0.012, 90CI[0.000, 0.036], SRMR =  0.042$ 

We can formally compare these with the *lavaan::lavTestLRT()* function.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
lavaan::lavTestLRT(struct_fit1, struct_fit2)
```
The chi-square difference test can be used to compare nested models. Models are nested when there is only the addition/deletion of paths or covariances. If the sample or variables change, they cannot be used. Our chi-square difference test was, $\Delta\chi^2(1) = 8.667, p = 0.032$. This suggests that there were statistically significant difference in our nested models, favoring the newer model.

Something about this should look suspiciously familiar. Do you notice the chi-square value itself? Earlier our modification indices told us that if we freed Spr and SSp to relate, the chi-square value would drop by 8.339. While not exact, the prediction was fairly spot on!

Additionally, the AIC and BIC can be used to compare non-nested models. Preferred models have lower values. In our case, the newer model appears to be preferred.

Is freeing this parameter an appropriate addition to our model, or is it *overparameterization*. We should also inspect the $d_1$ path and the serially mediated indirect effects. It does appear that regression weight from spirituality to social support (i.e., $d_1$) was statistically significant $(B = 0.477, p = 0.008)$ but the serially mediated indirect effects was not. Specifically, when mental health was the outcome, $B = 0.022, p =  0.737$; when physical health was the outcome, $B = -0.019, p = 0.800$.

Adding this path feels, to me, like overparameterization. In the case of model building, I will stick with the originally hypothesized model.

## Model Trimming

In model trimming, the researcher starts with a more general model or saturated (i.e., zero degrees of freedom in the structural model) and, on the basis of statistical criteria, trims non-significant (i.e., and low regression weight) paths from the model. Chou and Bentler [-@chou_model_2002] termed this *backward searching.* We have a number of non-significant paths. Should we delete them? And if so, how many of them?

The inclusion of indirect effects in our model makes it a little tricky to know how and where we might delete paths. As we look at the regression weights of our original model, I note that

* all *b* paths (except those involving disengagement coping) are non-significant,
* all indirect effects (except those involving disengagement coping) are non-significant,
* the *b* paths involving engagement coping are closest to being statistically significant.

It is a best practice to trim paths one at a time and then re-check the results. Why? Because the constraint may free up a little power and statistical significance for a regression path may turn on elsewhere.  Because this is a book chapter and constraining each non-significant effect one-at-a-time would (a) take forever and (b) make this chapter absolutely unwieldy, I will first delete the *b* paths associated with social support at the same time. So that I can keep track of what I'm doing in my code, I will hashtag them out. The elimination of these will also result in the elimination of the associated indirect effect; I will hashtag those out, also.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
struct_mod3 <- "
 ##measurement model
         GRMS =~ p1GRMS + p2GRMS + p3GRMS
         MH =~ p1MH + p2MH + p3MH  
         PhH =~ p1PhH + p2PhH + p3PhH 
         Spr =~ v1*Spirit1 + v1*Spirit2
         SSp =~ v2*SocS1 + v2*SocS2
         Eng =~ v3*Eng1 + v3*Eng2
         dEng =~ v4*dEng1 + v4*dEng2
         
         #structural model with labels for calculation of the indirect effect
         
         Eng ~ a1*GRMS
         Spr ~ a2*GRMS
         SSp ~ a3*GRMS
         dEng ~ a4*GRMS
         
         MH ~ c_p1*GRMS + b1*Eng + b2*Spr + b4*dEng #trimming + b3*SSp
         PhH ~ c_p2*GRMS  + b5*Eng + + b6*Spr + b8*dEng #trimming + b7*SSp 
         
         #cov
         MH ~~ 0*PhH #prevents MH and PhD from correlating
         
        #calculations
         indirect.EngMH :=  a1*b1
         indirect.SprMH :=  a2*b2
         #indirect.SSpMH :=  a3*b3 #trimmed after deleting b3, above
         indirect.dEngMH :=  a4*b4
         
         indirect.EngPhH :=  a1*b5
         indirect.SprPhH :=  a2*b6
         #indirect.SSpPhH :=  a3*b7 #trimmed after deleting b7, above
         indirect.dEngPhH :=  a4*b8
         direct.MH  := c_p1
         direct.PhH  := c_p2
         total.MH  := c_p1 + (a1*b1) + (a2*b2)  + (a4*b4) #trimmed + (a3*b3)
         total.PhH  := c_p2 + (a1*b5) + (a1*b6) + (a1*b8) #trimmed + (a1*b7) 

          "
set.seed(230916) #needed for reproducibility especially when specifying bootstrapped confidence intervals
struct_fit3 <- lavaan::sem(struct_mod3, data = dfLewis, missing= 'fiml')
struct_summary3 <- lavaan::summary(struct_fit3, fit.measures=TRUE, standardized=TRUE, rsq = TRUE)
struct_pEsts3 <- lavaan::parameterEstimates(struct_fit3, boot.ci.type = "bca.simple", standardized=TRUE)
struct_summary3
#struct_pEsts3 #although creating the object is useful to export as a .csv I didn't ask it to print into the book

```

Creating a figure will help us with the conceptual understanding of what we've just done (and will also help us check our work).

Let's first create a fresh plot from se

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot_struct3 <- semPlot::semPaths(struct_fit3, what = "col", whatLabels = "stand", sizeMan = 3, node.width = 1, edge.label.cex = .75, style = "lisrel", mar = c(2,2,2,2), structural = FALSE, curve=FALSE, intercepts=FALSE)
```
Because we haven't added or deleted variables (only 1 path) and we want them to stay in the same location with the same orientation of paths and covariances, we should be able to recycle some of the diagram code we created earlier

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot3 <- semptools::set_sem_layout(plot_struct3,
                                indicator_order = m1_indicator_order,
                                indicator_factor = m1_indicator_factor,
                                factor_layout = m1_msmt,
                                factor_point_to = m1_point_to,
                                indicator_push = m1_indicator_push,
                                indicator_spread = m1_indicator_spread)

#changing node labels
plot3 <- semptools::change_node_label(plot3,
                                   c(GRM = "GRMS",
                                     MH = "mHealth",
                                     PhH = "phHealth",
                                     Eng = "Engmt",
                                     dEn = "dEngmt",
                                     Spr = "Spirit",
                                     SSp = "SocSup"),
                                   label.cex = 1.1)

#adding stars to indicate significant paths
plot3 <- semptools::mark_sig(plot3, struct_fit3)

plot(plot3)
```
Close inspection shows that there are no longer *b* paths from social support to mental and physical health.

Curiously, even though we deleted two paths, our degrees of freedom was the same as the original model. This means that our fit indices will be identical: $\chi^2(109) = 120.319, p = 0.216, CFI = 0.994, RMSEA = 0.021, 90CI[0.000, 0.041], SRMR =  0.044$.

We can formally test differences in the two models with the *lavaan:lavTestLRT()* function.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
lavaan::lavTestLRT(struct_fit1, struct_fit3)
```
As shown, this df = 0 test indicated that the models are not statistically significantly different form each other.

When researchers engage in model trimming, their (typical) hope is that the models are not statistically significantly different from each other. Why? This means that the more parsimonious model (i.e., the nested model, the one with fewer paths/covariances) fits similarly to the sample covariance matrix (i.e., where all variables freely covary).

#### Extreme Model Trimming

In the description of the Lewis et al. [-@lewis_applying_2017], I noted that the researchers conducted eight simple mediations instead of two parallel mediations (for mental and physical health, respectively), or as we have done -- a complex SEM modeling all four mediators with both dependent variables. Given the small regression weights and very non-significant *p* values for spirituality and social support, I'm curious what would happen if we respecified the model, retaining only disengagement and engagement variables. This level of respecification would render our model as *non-nested* so our comparison would be limited to the AIC/BIC (lower values indicate better fit) and the global fit indices, themselves (without formal comparison).

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
struct_mod4 <- "
        ##measurement model
         GRMS =~ p1GRMS + p2GRMS + p3GRMS
         MH =~ p1MH + p2MH + p3MH  
         PhH =~ p1PhH + p2PhH + p3PhH 
         #Spr =~ v1*Spirit1 + v1*Spirit2 #trimmed altogether
         #SSp =~ v2*SocS1 + v2*SocS2 #trimmed altogether
         Eng =~ v3*Eng1 + v3*Eng2
         dEng =~ v4*dEng1 + v4*dEng2
         
         #structural model with labels for calculation of the indirect effect
         
         Eng ~ a1*GRMS
         #Spr ~ a2*GRMS #trimmed altogether
         #SSp ~ a3*GRMS #trimmed altogether
         dEng ~ a4*GRMS
         
         MH ~ c_p1*GRMS + b1*Eng + b4*dEng #trimming + b2*Spr + b3*SSp
         PhH ~ c_p2*GRMS  + b5*Eng  + b8*dEng #trimming + b6*Spr + b7*SSp 
         
         #cov
         MH ~~ 0*PhH #prevents MH and PhD from correlating
         
        #calculations
         indirect.EngMH :=  a1*b1
         #indirect.SprMH :=  a2*b2 #trimmed after deleting Spr
         #indirect.SSpMH :=  a3*b3 #trimmed after deleting SSp
         indirect.dEngMH :=  a4*b4
         
         indirect.EngPhH :=  a1*b5
         #indirect.SprPhH :=  a2*b6 #trimmed after deleting Spr
         #indirect.SSpPhH :=  a3*b7 #trimmed after deleting Ssp
         indirect.dEngPhH :=  a4*b8
         direct.MH  := c_p1
         direct.PhH  := c_p2
         total.MH  := c_p1 + (a1*b1) + (a4*b4) #trimmed  + (a2*b2)  + (a3*b3)
         total.PhH  := c_p2 + (a1*b5) + (a1*b8) #trimmed + (a1*b6) + (a1*b7) 

          "
set.seed(230916) #needed for reproducibility especially when specifying bootstrapped confidence intervals
struct_fit4 <- lavaan::sem(struct_mod4, data = dfLewis, missing= 'fiml')
struct_summary4 <- lavaan::summary(struct_fit4, fit.measures=TRUE, standardized=TRUE, rsq = TRUE)
struct_pEsts4<- lavaan::parameterEstimates(struct_fit4, boot.ci.type = "bca.simple", standardized=TRUE)
struct_summary4
#struct_pEsts4 #although creating the object is useful to export as a .csv I didn't ask it to print into the book

```

Creating a figure to represent our analysis will require us to tweak the full set of code.


```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
plot_struct4 <- semPlot::semPaths(struct_fit4, what = "col", whatLabels = "stand", sizeMan = 3, node.width = 1, edge.label.cex = .75, style = "lisrel", mar = c(2,2,2,2), structural = FALSE, curve=FALSE, intercepts=FALSE)
```
Although the code below may look daunting, I find it to be a fairly straightforward way to obtain figures that convey the model we are testing. We first start by identifying the desired location of our latent variables, using numbers to represent their position by "(column, row)". In the table below, I have mapped my variables. 

|Grid for Plotting semplot::sempath      
|:-------------|:-------------|:------------|
|(1,1)         |(1,2) Eng     |(1,3)        | 
|(2,1)         |(2,2)         |(2,3) MH     |
|(3,1) GRM     |(3,2)         |(3,3)        |
|(4,1)         |(4,2)         |(4,3) PhH    |
|(5,1)         |(5,2) dEn     |(5,3)        |




We place these values along with the names of our latent variables in to the *semptools::layout_matrix* function.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#IMPORTANT:  Must use the node names (take directly from the SemPlot) assigned by SemPlot
#You can change them as the last thing
m4_msmt <- semptools::layout_matrix(GRM = c(3,1),
                                  Eng = c(1,2),
                                  dEn = c(5,2),
                                  MH = c(2,3),
                                  PhH = c(4,3))

#tell where you want the indicators to face
m4_point_to <- semptools::layout_matrix (left = c(3,1),
                                      up = c(1,2),
                                      down = c(5,2),
                                       right = c(2,3),
                                       right = c(4,3))

#the next two codes -- indicator_order and indicator_factor are paired together, they specify the order of observed variables for each factor
m4_indicator_order <- c("p1G", "p2G", "p3G",
                     "p1M", "p2M", "p3M",
                     "p1P", "p2P", "p3P",
                     "En1", "En2",
                     "dE1", "dE2")

m4_indicator_factor <- c("GRM", "GRM", "GRM",
                      "MH", "MH", "MH",
                      "PhH", "PhH", "PhH",
                      "Eng", "Eng",
                      "dEn", "dEn")

#next set of code pushes the indicator variables away from the factor
m4_indicator_push <- c(GRM = .5, 
                    MH = 1,
                    PhH = 1,
                    Eng = 1.5,
                    dEn = 2)

#spreading the boxes away from each other
m4_indicator_spread <- c(GRM = .5, 
                    MH = 1,
                    PhH = 1, 
                    Eng = 1,
                    dEn = 1)

plot4 <- semptools::set_sem_layout(plot_struct4,
                                indicator_order = m4_indicator_order,
                                indicator_factor = m4_indicator_factor,
                                factor_layout = m4_msmt,
                                factor_point_to = m4_point_to,
                                indicator_push = m4_indicator_push,
                                indicator_spread = m4_indicator_spread)

#changing node labels -- throwing an error and I'm not sure why, it worked above
#plot4 <- semptools::change_node_label(plot4,
                                   #c(GRM = "GRMS",
                                     #MH = "mHealth",
                                    # PhH = "phHealth",
                                     #Eng = "Engmt",
                                     #dEn = "dEngmt",
                                     #label.cex = 1.1))

#adding stars to indicate significant paths
plot4 <- semptools::mark_sig(plot4, struct_fit4)

plot(plot4)
```

Our global fit indices were strong, $\chi^2(59) = 59.999, p = 0.439, CFI = 0.999, RMSEA = 0.009, 90CI[0.000, 0.042], SRMR =  0.043$. Yet the indirect effects for engagement remained non-significant. When mental health was the dependent variable, $B = 0.145, p = 0.098$; when physical health was the dependent variable, $B = 0.140, p = 0.152$.

If we formally compare the results, we can only use the AIC and BIC with lower values indicating better fit.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
lavaan::lavTestLRT(struct_fit1, struct_fit4)
```
Remember -- ignore the chi-square difference test. These are non-nested models. The AIC and BIC favor our trimmed model. 

What would I do? It would be tempting to simply report the results of engagement and disengagement coping -- yet the researchers were interested in the potential of all four coping strategies as potential mediators. Because our disengagement coping mediator remained statistically significant throughout all of our exploration, I would probably choose to report the full analysis because it provides useful information to future researchers and practitioners about the important contribution of disengagement coping (while controlling for the other mediators).

### APA Style Write-up of the Results

>**Method/Analytic Strategy**

>We specified a parallel mediation, predicting mental and physical health directly from gendered racial microaggressions and indirectly through four coping strategies (i.e., spirituality, social support, engagement, disengagement) The primary analysis occurred in two stages. First, we specified and evaluated a measurement model. Data were analyzed with a maximum likelihood approach the package, *lavaan* (v. 0.6-16). 

>**Results**

>**Preliminary Analyses**

>*  Missing data analyses and managing missing data>
>*  Bivariate correlations, means, SDs
>*  Distributional characteristics, assumptions, etc.
>*  Address limitations and concerns

>**Primary Analyses**
>Analyzing our proposed multiple mediator model followed the two-step procedure of first establishing a measurement model with acceptable fit to the data and then proceeding to test the structural model. Given that different researchers recommend somewhat differing thresholds to determine the adequacy of fit, We used the following as evidence of good fit: comparative fit indix (CFI) $\geq 0.95$, root-mean-square error of approximation (RMSEA) $\leq 0.06$, and the standard root-mean-square residual (SRMR) $\leq 0.08$. To establish aceptable fit, we used CFI $\geq 0.90$, RMSEA $\leq 0.10$, and SRMR $\leq 0.10$ [@weston_brief_2006].

>Following recommendations by Little et al. [@little_parcel_2002; @little_why_2013], each latent variable with six or more indicators was represented by three parcels. Parcels were created by randomly assigning scale items to the parcels and then calculating the mean, if at least 65% of the items were non-missing. For the four latent variables with only two indicators each, we constrained the factor loadings to be equal. Factor loadings were all strong, statistically significant, and properly valenced. Global fit statistics were within acceptable thresholds ($\chi^2(102) = 94.122, p = 0.698, CFI = 1.000, RMSEA = 0.000, 90CI[0.000,	 0.028], SRMR =  0.034$). Thus, we proceeded to testing the structural model.

>Our structural model was a parallel mediation, predicting mental and physical health directly from gendered racial microaggressions and indirectly through four coping strategies (i.e., spirituality, social support, engagement, disengagement). Results of the global fit indices suggested good fit $\chi^2(109) = 120.324, p = 0.216, CFI = 0.994, RMSEA = 0.021, 90CI[0.000, 0.041], SRMR =  0.044$. As shown in Table 2 only two of the eight indirect effects was statistically significant. For both, disengagement coping mediated the effect of gendered racial microaggressions on mental health $(B = -0.328, p = 0.007)$ and physical health $(B = -0.241, p = 0.039)$. The model accunted for 48-68% of the variance in the mediators and 58% and 30% of the variance in mental and physical health, respectively.

>Although the model fit was strong, we considered respecification. Modification indices suggested adding a path that would result in a serial mediation from gendered racial microaggressions, to spirituality, to social support and then to each of the dependent variables. While model fit $(\chi^2(108) = 111.657, p = 0.385, CFI = 0.998, RMSEA = 0.012, 90CI[0.000, 0.036], SRMR =  0.042)$ was statistically significantly improved in favor of the serially mediated model $(\Delta\chi^2(1) = 8.667, p = 0.032)$, the serially mediated indirect effects to mental $(B = -0.022, p = 0.737)$ and physical health $(B= -0.019, p = 0.800)$ were non-significant. Consequently, we retained our originally hypothesized model.

>We also considered model trimming. Considering both theory plus regression weights and associated *p* values of the originally hypothesized model, we noted that spiritual and social support coping were not statistically significant with low regression weights. We further noted that engagement coping approached statistical significance. We trimmed the spiritual and social support mediators altogether. While the resulting model (with only engagement and disengagement coping) evidenced strong fit $(\chi^2(59) = 59.999, p = 0.439, CFI = 0.999, RMSEA = 0.009, 90CI[0.000, 0.042], SRMR =  0.043)$, the indirect effects to mental health $(B = 0.145, p = 0.098)$ and physical health $(B = 0.140, p = 0.152)$ through engagement coping remained non-significnant. Because conveying information about significant and not signficant paths are important to future researchers and practitioners, we retained the originally hypothesized model.

## STAY TUNED

A section on power analysis is planned and coming soon! My apologies that it's not quite *R*eady.


## Practice Problems
   
In each of these lessons I provide suggestions for practice that allow you to select one or more problems that are graded in difficulty. With each of these options I encourage you to start with a hypothesized model that has at least four variables and is over-identified. Overall you will (a) start with an established measurement model, (b) test a structural model, (c) use modification indices to add a path or covariance and evaluate the change to the model, (d) use strength and significance of regression weights to trim at least one path or covariance and evaluate the change to the model, (e) make a final decision about the model you retain, (f) provide an APA style representation of the results (with table[s] and figure[s]) .

### Problem #1: Change the random seed

Simply change the random seed in the data simulation, then rework the problem evaluated in this chapter. It is possible to further simplify this model by deleting a pair of the mediators and/or one of the dependent variables.

### Problem #2: Swap one or more of the variables

The Lewis et al. [-@lewis_applying_2017] study included the additional variable of gendered racial identity centrality. Consider substituting it as an independent or dependent variable.

### Problem #3:  Try something entirely new.

Conduct a hybrid analysis using data for which you have permission and access (e.g.,  IRB approved data you have collected or from your lab; data you simulate from a published article; data from an open science repository; data from other chapters in this OER).

Regardless of your choic(es) complete all the elements listed in the grading rubric.

Using the lecture and workflow (chart) as a guide, please work through all the steps listed in the proposed assignment/grading rubric.

|Assignment Component                    | Points Possible   | Points Earned|
|:-------------------------------------- |:----------------: |:------------:|
|1. Identify the structural model you will evaluate. It should have a minimum of four variables and could be one of the prior path-level models you already examined.|5              |_____         |  
|2. Import the data and format the variables in the model.|5 |_____         |           
|3. Specify and evaluate a *measurement* model that you have established.|10 |_____|  
|4. Specify and evaluate a *structural* model. For the purpose of this exercise, the structural model should be over-identified, that is, should have positive degrees of freedom. How many degrees of freedom does your structural model have?|   10         |_____         |   
|5. Use modification indices to add at least one path or covariance.| 10    |_____ |
|6. Conduct a formal comparison of *global* fit between the original and respecified model.|5|_____|
|7. Using the strength and significance of regression weights as a guide, trim at least path or covariance.| 10    |_____ |
|8. Conduct a formal comparison of *global* fit between the original (or built) and trimmed model.|5|_____|
|9. APA style results with table(s) and figure(s).|    5           |_____         |       
|10. Explanation to grader.                 |      5          |_____         |
|**Totals**                               |      65          |_____         |          


```{r, child= 'Worked_Examples/20-9-woRked_TrimBuild.Rmd'}
``` 

```{r include=FALSE}
sessionInfo()
```



